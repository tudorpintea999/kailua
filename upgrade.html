<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>On-chain - The Kailua Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "ayu";
            const default_dark_theme = "ayu";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kailua Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/risc0/kailua" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/risc0/kailua/edit/main/book/src/upgrade.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="on-chain-contracts"><a class="header" href="#on-chain-contracts">On-chain Contracts</a></h1>
<p>In order to utilize Kailua, you'll need to deploy the Kailua dispute contracts, and configure your rollup to use them.
This process will require access to your rollup's 'Owner' and 'Guardian' wallets.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The steps required to upgrade your on-chain rollup contracts to support Kailua are as follows:</p>
<ol>
<li>(Optional) Deploy a RISC Zero Verifier contract set.
<ul>
<li>This can be skipped by using a pre-existing verifier contract.</li>
</ul>
</li>
<li>Deploy a <code>KailuaTreasury</code> and a <code>KailuaGame</code> contract with your configuration.</li>
<li>Initialize the <code>KailuaTreasury</code> contract to mark the start of sequencing under Kailua.</li>
<li>Update the rollup's <code>DisputeGameFactory</code> contract to use <code>KailuaGame</code> for sequencing proposals.
<ul>
<li>(Optional) Designate a Vanguard proposer.</li>
<li>(Optional) Enable withdrawals using finalized Kailua proposals.</li>
</ul>
</li>
</ol>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip"></a>
</div>
<div>
<p>The Kailua CLI has a <code>fast-track</code> command for automating the L1 transactions required to migrate to Kailua.
If the command does not yet support your configuration, you'll need to follow the manual steps in the next sub-sections.</p>
</div>
</div>
<div id="admonition-hint" class="admonition admonish-tip" role="note" aria-labelledby="admonition-hint-title">
<div class="admonition-title">
<div id="admonition-hint-title">
<p>Hint</p>
</div>
<a class="admonition-anchor-link" href="#admonition-hint"></a>
</div>
<div>
<p>You might find it useful to rehearse migration using a local devnet first.</p>
</div>
</div>
<h3 id="estimated-gas-costs"><a class="header" href="#estimated-gas-costs">Estimated Gas Costs</a></h3>
<p>The below table contains rounded-up gas cost estimates of various contract operations</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Contract</th><th style="text-align: left">Operation</th><th style="text-align: right">Gas</th><th>Notes</th></tr></thead><tbody>
<tr><td style="text-align: left">RiscZeroVerifierRouter</td><td style="text-align: left">deploy</td><td style="text-align: right">800K</td><td></td></tr>
<tr><td style="text-align: left">RiscZeroVerifierRouter</td><td style="text-align: left">addVerifier</td><td style="text-align: right">50K</td><td></td></tr>
<tr><td style="text-align: left">RiscZeroGroth16Verifier</td><td style="text-align: left">deploy</td><td style="text-align: right">1,300K</td><td></td></tr>
<tr><td style="text-align: left">RiscZeroMockVerifier</td><td style="text-align: left">deploy</td><td style="text-align: right">615K</td><td></td></tr>
<tr><td style="text-align: left">KailuaTreasury</td><td style="text-align: left">deploy</td><td style="text-align: right">5,200K</td><td></td></tr>
<tr><td style="text-align: left">KailuaTreasury</td><td style="text-align: left">propose</td><td style="text-align: right">400K</td><td>1 blob</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">deploy</td><td style="text-align: right">5,000K</td><td></td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveValidity</td><td style="text-align: right">375K</td><td>Groth16 proof</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveOutputFault</td><td style="text-align: right">415K</td><td>Groth16 + 1 KZG proofs</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveOutputFault</td><td style="text-align: right">470K</td><td>Groth16 + 2 KZG proofs</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveNullFault</td><td style="text-align: right">171K</td><td>1 KZG proof</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">120K</td><td>Undisputed</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">160K</td><td>1 fault</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">280K</td><td>2 faults</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">370K</td><td>3 faults</td></tr>
</tbody></table>
</div>
<h2 id="fast-track-migration"><a class="header" href="#fast-track-migration">Fast-track Migration</a></h2>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info"></a>
</div>
<div>
<p>The fast-track migration tool is restricted to certain rollup deployment configurations.
As the tool is improved to accommodate more setups, these requirements will be relaxed.</p>
</div>
</div>
<h3 id="requirements"><a class="header" href="#requirements">Requirements</a></h3>
<ol>
<li>The "Owner" account must be a "Safe" contract instance controlled by a single private-key controlled wallet (EOA).</li>
<li>The "Guardian" account must be a private-key controlled wallet (EOA).</li>
<li>You must have access to the raw private key(s) above.</li>
</ol>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip-1"></a>
</div>
<div>
<p>You can skip the guardian key/account requirements if you do not wish to enable withdrawals against sequencing proposals
made by Kailua as part of the fast-track process via the <code>respect-kailua-proposals</code> flag.
You can enable withdrawals manually later using the <code>OptimismPortal2</code> contract.</p>
</div>
</div>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>If all the above conditions are met, you can fast track the migration of your rollup to Kailua as follows:</p>
<pre><code class="language-shell">kailua-cli fast-track \
      --eth-rpc-url [YOUR_ETH_RPC_URL] \
      --op-geth-url [YOUR_OP_GETH_URL] \
      --op-node-url [YOUR_OP_NODE_URL] \
\
      --starting-block-number [YOUR_STARTING_BLOCK_NUMBER] \
      --proposal-output-count [YOUR_OUTPUTS_PER_PROPOSAL] \
      --output-block-span [YOUR_BLOCKS_PER_OUTPUT] \
\
      --collateral-amount [YOUR_COLLATERAL_AMOUNT] \
      --verifier-contract [RISC_ZERO_VERIFIER_ADDRESS] \
      --challenge-timeout [YOUR_CHALLENGE_PERIOD] \
\
      --deployer-key [YOUR_DEPLOYER_KEY] \
      --owner-key [YOUR_OWNER_KEY] \
      --guardian-key [YOUR_GUARDIAN_KEY] \
\
      --vanguard-address [YOUR_VANGUARD_ADDRESS] \
      --vanguard-advantage [YOUR_VANGUARD_ADVANTAGE] \
\
      --respect-kailua-proposals
</code></pre>
<div id="admonition-tip-2" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-2-title">
<div class="admonition-title">
<div id="admonition-tip-2-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="#admonition-tip-2"></a>
</div>
<div>
<p>All the parameters above can be provided as environment variables.</p>
</div>
</div>
<h4 id="endpoints"><a class="header" href="#endpoints">Endpoints</a></h4>
<p>The first three parameters to this command are the L1 and L2 RPC endpoints:</p>
<ul>
<li><code>eth-rpc-url</code>: The endpoint for the parent chain.</li>
<li><code>op-geth-url</code>: The endpoint for the rollup execution client.</li>
<li><code>op-node-url</code>: The endpoint for the rollup consensus client.</li>
</ul>
<h4 id="sequencing"><a class="header" href="#sequencing">Sequencing</a></h4>
<p>The next three parameters configure sequencing:</p>
<ul>
<li><code>starting-block-number</code>: The rollup block number to immediately finalize and start sequencing from.</li>
<li><code>proposal-output-count</code>: The number of intermediate output commitments published per proposal.</li>
<li><code>output-block-span</code>: The number of rollup blocks each intermediate output commitment must cover.</li>
</ul>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="#admonition-warning"></a>
</div>
<div>
<p>The sequencing state at the block <code>starting-block-number</code> as reported by the <code>op-node</code> will be finalized without delay.</p>
</div>
</div>
<h4 id="fault-proving"><a class="header" href="#fault-proving">Fault Proving</a></h4>
<p>The next three parameters configure fault proving:</p>
<ul>
<li><code>collateral-amount</code>: The amount of collateral (in wei) a sequencer has to stake before publishing proposals.</li>
<li><code>verifier-contract</code>: (Optional) The address of the existing RISC Zero verifier contract to use. If this argument is omitted, a new set of verifier contracts will be deployed.
<ul>
<li>If you wish to use an already existing verifier, you must provide this argument, even if the <code>config</code> command had located a verifier.</li>
<li>If you are deploying a new verifier contract and wish to support fake proofs generated in dev mode (insecure), make sure to set <code>RISC0_DEV_MODE=1</code> in your environment before invoking the <code>fast-track</code> command.</li>
</ul>
</li>
<li><code>challenge-timeout</code>: The timeout (in seconds) for a sequencing proposal to be contradicted.</li>
</ul>
<h4 id="ethereum-transactions"><a class="header" href="#ethereum-transactions">Ethereum Transactions</a></h4>
<p>The next three parameters are the private keys for the respective parent chain wallets:</p>
<ul>
<li><code>deployer-key</code>: Private key for the EOA used to deploy the new Kailua contracts.</li>
<li><code>owner-key</code>: Private key for the sole EOA controlling the Owner "Safe" contract.</li>
<li><code>guardian-key</code>: Private key for the EOA used as the "Guardian" of the optimism portal.</li>
</ul>
<h5 id="kms-support"><a class="header" href="#kms-support">KMS Support</a></h5>
<p>Instead of raw private keys, you can use either AWS or GCP for obtaining transaction signatures from a KMS.</p>
<ul>
<li>AWS: Specify a corresponding <code>[EOA]-aws-key-id</code> parameter. The remainder of the <a href="https://docs.aws.amazon.com/sdkref/latest/guide/creds-config-files.html">AWS configuration</a> is handled by the AWS SDK.
<ul>
<li>Example: <code>deployer-aws-key-id</code>.</li>
</ul>
</li>
<li>GCP: Specify the corresponding <code>[EOA]-google-project-id</code>, <code>[EOA]-google-location</code>, <code>[EOA]-google-keyring</code> and <code>[EOA]-google-key-name</code> parameters.
<ul>
<li>Example: <code>owner-google-project-id</code>, <code>owner-google-location</code>, <code>owner-google-keyring</code> and <code>owner-google-key-name</code>.</li>
</ul>
</li>
</ul>
<h4 id="vanguard-proposer"><a class="header" href="#vanguard-proposer">Vanguard Proposer</a></h4>
<p>The next two (optional) parameters define the Vanguard proposer advantage:</p>
<ul>
<li><code>vanguard-address</code>: The address of the designated Vanguard.</li>
<li><code>vanguard-advantage</code>: The amount of time (in seconds) to grant proposal exclusivity to the Vanguard.
<ul>
<li>If unspecified, this defaults to <code>1152921504606846975</code> (a practically indefinite advantage of 36 Billion years).</li>
</ul>
</li>
</ul>
<h4 id="withdrawals"><a class="header" href="#withdrawals">Withdrawals</a></h4>
<div id="admonition-bug" class="admonition admonish-bug" role="note" aria-labelledby="admonition-bug-title">
<div class="admonition-title">
<div id="admonition-bug-title">
<p>Bug</p>
</div>
<a class="admonition-anchor-link" href="#admonition-bug"></a>
</div>
<div>
<p>Changing the respected game type to Kailua may crash the <code>op-proposer</code> provided by optimism depending on its version.
This should be inconsequential because you'll need to run the Kailua proposer for further sequencing to take place anyway.</p>
</div>
</div>
<p>The final argument configures withdrawals in your rollup:</p>
<ul>
<li><code>respect-kailua-proposals</code>: (if present) will allow withdrawals using sequencing proposals finalized by Kailua.</li>
</ul>
<div id="admonition-done" class="admonition admonish-success" role="note" aria-labelledby="admonition-done-title">
<div class="admonition-title">
<div id="admonition-done-title">
<p>Done</p>
</div>
<a class="admonition-anchor-link" href="#admonition-done"></a>
</div>
<div>
<p>If you've successfully completed fast-track migration using the tool, you may now skip to the <a href="./operate.html">Off-chain page</a>.</p>
</div>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="parameters.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="verifier.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="parameters.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="verifier.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>



    </div>
    </body>
</html>
