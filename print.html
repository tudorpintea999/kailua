<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Kailua Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "ayu";
            const default_dark_theme = "ayu";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kailua Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/risc0/kailua" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="kailua"><a class="header" href="#kailua">Kailua</a></h1>
<p><a href="https://github.com/risc0/kailua"><img src="https://img.shields.io/badge/GitHub-kailua-green?logo=github" alt="Static Badge" /></a></p>
<p>This document is a guide to the design, implementation, and usage of RISC Zero's Kailua.</p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>Kailua is suite of tools and contracts for upgrading Optimistic rollups to use ZK Fault Proofs powered by the RISC Zero zkVM.
Kailua introduces its own novel fault proof game design which provides the best in class security guarantees for sequencing rollup transactions.
These benefits come at marginal added operational costs compared to full validity proving.</p>
<h3 id="withdrawal-delay"><a class="header" href="#withdrawal-delay">Withdrawal Delay</a></h3>
<p>A delay attack happens when a dishonest party attempts to delay the withdrawal finality of correctly sequenced transactions.
For optimistic rollups, the main attack vector is through triggering on-chain disputes using the fault proving mechanism.</p>
<div id="admonition-check" class="admonition admonish-success" role="note" aria-labelledby="admonition-check-title">
<div class="admonition-title">
<div id="admonition-check-title">
<p>Check</p>
</div>
<a class="admonition-anchor-link" href="introduction.html#admonition-check"></a>
</div>
<div>
<p>Kailua's dispute resolution mechanism resolves disputes as fast as proofs can be generated.
Thanks to the RISC Zero zkVM's scale-out design, this means that the impact of delay attacks can be mitigated with
more proving power.
For example, the worst-case single-block dispute requires proving 100bn cycles in the zkVM, a workload that can be
computed by RISC Zero's Bonsai service in under an hour.</p>
</div>
</div>
<h3 id="denial-of-service"><a class="header" href="#denial-of-service">Denial-of-Service</a></h3>
<p>Assuming an honest majority operates the parent chain of the rollup, on-chain denial-of-service attacks can still
happen if a wealthy party raises the on-chain gas costs beyond what honest participants in the fault proof protocol can
afford.
This block congestion attack can effectively censor disputes against faulty sequencing proposals from being made
on-chain, threatening the safety of the rollup.</p>
<div id="admonition-check-1" class="admonition admonish-success" role="note" aria-labelledby="admonition-check-1-title">
<div class="admonition-title">
<div id="admonition-check-1-title">
<p>Check</p>
</div>
<a class="admonition-anchor-link" href="introduction.html#admonition-check-1"></a>
</div>
<div>
<p>Kailua's design incorporates "Adaptive Dispute Cutoffs", which delays withdrawal finality to increase the dispute
opportunity based on the level of on-chain congestion. This guarantees that if faults cost more to dispute than a
predetermined amount, honest parties will be granted more time until gas costs subside.</p>
</div>
</div>
<h3 id="sybil-identities"><a class="header" href="#sybil-identities">Sybil Identities</a></h3>
<p><strong>Whale</strong> attackers can overwhelm honest parties in a dispute resolution mechanism by using multiple identities to flood
the system with disputes.
In fault proving schemes where a defender has to issue a timely response on-chain to every dispute, the costs borne
by the defender to continuously participate in all open disputes until they are resolved can be overwhelming, leading
to some faults slipping through.</p>
<div id="admonition-check-2" class="admonition admonish-success" role="note" aria-labelledby="admonition-check-2-title">
<div class="admonition-title">
<div id="admonition-check-2-title">
<p>Check</p>
</div>
<a class="admonition-anchor-link" href="introduction.html#admonition-check-2"></a>
</div>
<div>
<p>Sybil attacks against Kailua force attackers to prove each other's faults at no added cost to the honest defender.
The only requirement for safety in Kailua is for an honest party to submit a correct sequencing proposal.
The added requirement for liveness is for disputes to be resolved through proofs, which carry no time limit to
generate.</p>
</div>
</div>
<h3 id="resource-exhaustion"><a class="header" href="#resource-exhaustion">Resource Exhaustion</a></h3>
<p>Some fault proof protocols require additional collateral to be staked for every move made in the system, while others
require proofs to be generated in a timely manner.
These two requirements cause some other systems to be vulnerable to resource exhaustion, where the resource can be
the collateral or the proving power required for an honest party to issue a timely response, even if it can afford the
transaction fees.</p>
<div id="admonition-check-3" class="admonition admonish-success" role="note" aria-labelledby="admonition-check-3-title">
<div class="admonition-title">
<div id="admonition-check-3-title">
<p>Check</p>
</div>
<a class="admonition-anchor-link" href="introduction.html#admonition-check-3"></a>
</div>
<div>
<p>Kailua operates under constant collateral requirements for honest parties, and places no restrictions on proving
times, enabling honest parties to successfully defend against attacks of any size at a pre-determined maximum cost.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="quickstart"><a class="header" href="#quickstart">Quickstart</a></h1>
<p>Kailua enables rollup operators to add a new fault proof system to their rollup via the Optimism <code>DisputeGameFactory</code>
contract.
Kailua's contracts rely on RISC-Zero zkVM proofs to finalize/dismiss output proposals, and are compatible with
Optimism's Bedrock contracts <code>v1.4.0</code> and above.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<ol>
<li><a href="https://www.rust-lang.org/tools/install">rust</a></li>
<li><a href="https://just.systems/man/en/">just</a></li>
<li><a href="https://www.docker.com/">docker</a></li>
<li><a href="https://github.com/alloy-rs/svm-rs">svm</a></li>
<li><a href="https://book.getfoundry.sh/getting-started/installation">foundry</a></li>
</ol>
<h2 id="live-chain"><a class="header" href="#live-chain">Live Chain</a></h2>
<p>You can test out Kailua's validity proving on a running chain through the following commands:</p>
<ol>
<li><code>just build</code>
<ul>
<li>Compiles a release build of Kailua</li>
</ul>
</li>
<li><code>just demo [BLOCKS_PER_PROOF] [L1_RPC] [BEACON_RPC] [L2_RPC] [OP_NODE_RPC]:</code>
<ul>
<li>Runs the release build against the target chain endpoints.</li>
<li>See <a href="validator.html#delegated-proof-generation">here</a> for advanced proving configuration</li>
</ul>
</li>
</ol>
<h2 id="local-devnet"><a class="header" href="#local-devnet">Local Devnet</a></h2>
<p>You can deploy a local optimism devnet equipped with Kailua through the following commands:</p>
<ol>
<li><code>just devnet-fetch</code>
<ul>
<li>Fetches <code>v1.9.1</code> of the <code>optimism</code> monorepo.</li>
</ul>
</li>
<li><code>just devnet-build</code>
<ul>
<li>Builds the local cargo and foundry projects.</li>
</ul>
</li>
<li><code>just devnet-up</code>
<ul>
<li>Starts a local OP Stack devnet using docker.</li>
<li>Dumps the output into <code>devnetlog.txt</code> for inspection.</li>
</ul>
</li>
<li><code>just devnet-upgrade</code>
<ul>
<li>Upgrades the devnet to use the <code>KailuaGame</code> contract.</li>
<li>Assumes the default values of the local optimism devnet, but can take parameters.</li>
</ul>
</li>
<li><code>just devnet-propose</code>
<ul>
<li>Launches the Kailua proposer.</li>
<li>This runs the sequences, which periodically creates new <code>KailuaGame</code> instances.</li>
</ul>
</li>
<li><code>just devnet-validate</code>
<ul>
<li>Launches the Kailua validator.</li>
<li>This monitors <code>KailuaGame</code> instances for disputes and creates proofs to resolve them.</li>
<li>(VALIDITY PROVING) Use <code>just devnet-validate [block-height]</code> to generate validity proofs to fast-forward finality until the specified L2 block height.</li>
<li>(DEVELOPMENT MODE): Use <code>RISC0_DEV_MODE=1</code> to use fake proofs.</li>
</ul>
</li>
<li><code>just devnet-fault</code>
<ul>
<li>Deploys a single <code>KailuaGame</code> instance with a faulty sequencing proposal.</li>
<li>Tests the validator's fault proving functionality.</li>
<li>Tests the proposer's canonical chain tracking functionality.</li>
</ul>
</li>
<li>After you're done:
<ul>
<li><code>just devnet-down</code> to stop the running docker containers.</li>
<li><code>just devnet-clean</code> to cleanup the docker volumes.</li>
</ul>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="design-overview"><a class="header" href="#design-overview">Design Overview</a></h1>
<p>Kailua's ZK fault proof game operates seamlessly in two main ways:</p>
<ol>
<li>Disputes are non-interactive, removing the need for a "bisection" or multi-round on-chain search for a fault.</li>
<li>Disputes are implicit between contradictory proposals, removing the need for a special "challenge" transaction.</li>
</ol>
<h2 id="sequencing"><a class="header" href="#sequencing">Sequencing</a></h2>
<p>Sequencing proposals in Kailua can utilize the publication of extra data instead of only the single commitment submitted in other protocols
in order to reduce the amount of proving work required to resolve disputes.
This extra data consists of commitments to the intermediate sequencing states, which allows the generated ZK proofs to
target only a sub-sequence of blocks comprising one transition between the intermediate states instead of the entire
proposal.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="design.html#admonition-note"></a>
</div>
<div>
<p>While Kailua can be configured to operate using a single published commitment per proposal, this may make the proving
work required to resolve disputes expensive for chains with very low block times, or a significantly large number
of blocks per proposal in general.</p>
</div>
</div>
<div style="text-align: center;">
<pre class="mermaid">---
title: Example Kailua Sequencing Proposal
---
graph LR;
  A -.8.-&gt; B((B)) -.8.-&gt; C((C)) -.8.-&gt; D((D)) -.8.-&gt; E((E)) -.8.-&gt; F((F)) -.8.-&gt; G((G)) -.8.-&gt; H((H)) -.8.-&gt; I;
</pre>
<pre class="mermaid">---
title: Example Standard Sequencing Proposal
---
graph LR;
  A --64--&gt; I;
</pre>
</div>
<p>The above two diagrams illustrate the extended data in Kailua sequencing proposals.
While a standard proposal for sequencing 64-blocks would only comprise a single commitment, the Kailua variant here is
configured to also require the commitment for every 8th block.
In this configuration, any Kailua fault proof would only have to provably derive a sequence of at most 8 blocks.</p>
<h2 id="disputes"><a class="header" href="#disputes">Disputes</a></h2>
<p>Each new sequencing proposal implicitly disputes the last existing proposal that contradicts it.
Once this happens, a proof is required to demonstrate which of the two contradictory proposals, if any, commits to the
correct sequencing state at their first point of divergence.
The proof then eliminates one, or both, contradictory proposals, and neither proposals can be finalized until the proof
is submitted.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="design.html#admonition-note-1"></a>
</div>
<div>
<p>While any new contradictory proposal has to be made within the timeout period of the prior proposal it contradicts,
proofs are granted an unlimited amount of time for permissionless submission by anyone.</p>
</div>
</div>
<div style="text-align: center;">
<pre class="mermaid">---
title: Disputes Example
---
graph LR;
    A --&gt; B;
    A --✓--&gt; B';
    A --✓--&gt; B'';
    
    B --&gt; C';
    B --✓--&gt; C;
    
    B' --&gt; C'';
    C --&gt; D;

    D --&gt; E;    
    D --✗--&gt; E';
</pre>
</div>
<p>Consider the above example scenario, where proposal <code>A</code> is finalized, while <code>B</code>, <code>C</code>, <code>D</code> and <code>E</code> are the only correct sequencing
proposals pending finalization, while all others are invalid.</p>
<p>A plain edge from a parent to a child indicates that the child proposal was made while no contradictory siblings should have existed.
A checkmark on the edge indicates that the proposal was made within the timeout period of the contradicotry sibling.
A crossmark indicates that the timeout period of the contradictory sibling proposal had expired before the child proposal was introduced.</p>
<p>The following three challenges are the only ones implied:</p>
<ol>
<li><code>B'</code> challenges <code>B</code></li>
<li><code>B''</code> challenges <code>B</code> (the proof for the prior challenge will eliminate <code>B'</code>).</li>
<li><code>C</code> challenges <code>C'</code>.</li>
</ol>
<p>The following two invalid proposals created no challenges:</p>
<ol>
<li><code>C''</code> has no siblings and therefore causes no implicit challenges, but will be eliminated once its parent <code>B'</code> is eliminated.</li>
<li><code>E'</code> was made after the timeout period for <code>E</code> had expired, and was automatically eliminated.</li>
</ol>
<p>In this scenario, <code>B</code> can only be finalized once two proofs are submitted to resolve its disputes against <code>B'</code> and <code>B''</code>.
Proposal <code>C</code> can only be finalized once a proof resolves its dispute against <code>C'</code>, and its parent <code>B</code> is finalized.
<code>D</code> has no contenders and can be finalized once its parent <code>C</code> is finalized.
The timeout period for <code>E</code> had passed before <code>E'</code> was introduced, and therefore <code>E</code> can be finalized once its parent <code>D</code> is finalized.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="project"><a class="header" href="#project">Project</a></h1>
<p>Kailua's project structure is primarily as follows:</p>
<pre><code>kailua                      // Root project directory
├── bin                     
│   └── cli                 // Main Kailua CLI
├── book                    // This document
├── build                   
│   └── risczero            // RISC Zero zkVM proving backend
├── crates                  
│   ├── common              // Fault proving primitives
│   ├── contracts           // Fault proof contracts
│   ├── proposer            // Sequencing proposal submitter
│   ├── prover              // Proof generation orcherstrator
│   ├── sync                // Sequencing proposal tracker
│   └── validator           // Sequencing proposal validator
├── justfile                // Convenience commands
└── testdata
    └── 16491249            // Example FPVM test data for op-sepolia block
</code></pre>
<h2 id="cli"><a class="header" href="#cli">CLI</a></h2>
<p>The CLI for Kailua is designed to support seven commands:</p>
<ul>
<li><code>config</code>: Outputs configuration information required for migration.</li>
<li><code>demo</code>: Automatically generate validity proofs for any running L2 chain.</li>
<li><code>fast-track</code>: Automatically upgrades an existing rollup deployment to utilize Kailua for fault proving.</li>
<li><code>propose</code>: Monitor a rollup for sequencing state and publish proposals on-chain (akin to op-proposer).</li>
<li><code>validate</code>: Monitor a rollup for disputes and publish the necessary FPVM proofs for resolution.</li>
<li><code>benchmark</code>: Generates proofs for performance benchmarking.</li>
<li><code>fault</code>: Submit garbage proposals to test fault proving.</li>
</ul>
<h2 id="contracts"><a class="header" href="#contracts">Contracts</a></h2>
<p>The contracts directory is a foundry project comprised of the following main contracts:</p>
<ul>
<li><code>KailuaTournament.sol</code>: Logic for resolving disputes between contradictory proposals.</li>
<li><code>KailuaTreasury.sol</code>: Logic for maintaining collateral and paying out provers for resolving disputes.</li>
<li><code>KailuaGame.sol</code>: Logic for introducing new sequencing proposals.</li>
<li><code>KailuaLib.sol</code>: Misc. utilities.</li>
</ul>
<p>The <code>kailua-contracts</code> crate builds and exports these contracts in Rust.</p>
<h2 id="fpvm"><a class="header" href="#fpvm">FPVM</a></h2>
<p>The Kailua FPVM executes Optimism's <code>Kona</code> inside the RISC Zero zkVM to derive and execute optimism blocks and create fault proofs.
The following project components work together to enable this functionality:</p>
<ul>
<li><code>build/risczero/fpvm</code>: The zkVM binary to create ZK fault proofs with <code>Kona</code>.</li>
<li><code>crates/common</code>: A wrapper crate around <code>Kona</code> with utilities for efficient ZK fault proving.</li>
<li><code>crates/prover</code>: An orchestrator for proof generation locally, remotely on Bonsai, or through Boundless.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<p>Make sure to first install the <a href="quickstart.html#prerequisites">prerequisites</a> from the quickstart
section before proceeding.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>Before you can start migrating your rollup, you'll need to build and install Kailua's binaries by calling the following
commands from the root project directory:</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="setup.html#admonition-tip"></a>
</div>
<div>
<p>If you have modified the FPVM binary, you will need to build/install using <code>-F rebuild-fpvm</code>.</p>
</div>
</div>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="setup.html#admonition-info"></a>
</div>
<div>
<p>At the cost of longer compilation time, you can embed the RISC Zero zkvm prover logic into <code>kailua-cli</code> instead of
having it utilize your locally installed RISC Zero <code>r0vm</code> for proving.
To do this, add <code>-F prove</code> to the install command below.</p>
</div>
</div>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="setup.html#admonition-tip-1"></a>
</div>
<div>
<p>For GPU-accelerated local proving, use one of the following feature flags:</p>
<ul>
<li>Apple: <code>-F metal</code></li>
<li>Nvidia: <code>-F cuda</code></li>
</ul>
</div>
</div>
<h3 id="cli-binary"><a class="header" href="#cli-binary">CLI Binary</a></h3>
<pre><code class="language-shell">cargo install kailua-cli --path bin/cli --locked
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Once your installation is successful, you should be able to run the following command to fetch the Kailua configuration
parameters for your rollup instance:</p>
<pre><code class="language-shell">kailua-cli config --op-node-url [YOUR_OP_NODE_URL] --op-geth-url [YOUR_OP_GETH_URL] --eth-rpc-url [YOUR_ETH_RPC_URL]
</code></pre>
<p>Running the above command against the respective Base mainnet endpoints should produce the following output:</p>
<pre><code>RISC0_VERSION: 2.2.0
FPVM_IMAGE_ID: 0x3918344017507B670B2DE3344D656D74E4B7A82C6E10C6C693A824AF3598CC24
FPVM_ELF_SIZE: 36289160
CONTROL_ROOT: 0xCE52BF56033842021AF3CF6DB8A50D1B7535C125A34F1A22C6FDCF002C5A1529
CONTROL_ID: 0x04446E66D300EB7FB45C9726BB53C793DDA407A62E9601618BB43C5C14657AC0
RISC_ZERO_VERIFIER: 0x8EAB2D97DFCE405A1692A21B3FF3A172D593D319
GENESIS_TIMESTAMP: 1686789347
BLOCK_TIME: 2
ROLLUP_CONFIG_HASH: 0x0D2CFA12746085B0CBFCB344D7100F873BA380535218A0795F9F4DE43EA92AE7
DISPUTE_GAME_FACTORY: 0x43EDB88C4B80FDD2ADFF2412A7BEBF9DF42CB40E
OPTIMISM_PORTAL: 0x49048044D57E1C92A77F79988D21FA8FAF74E97E
KAILUA_GAME_TYPE: 1337
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="setup.html#admonition-warning"></a>
</div>
<div>
<p>Make sure that your <code>FPVM_IMAGE_ID</code> matches the value above.
This value determines the exact program used to prove faults.</p>
</div>
</div>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="setup.html#admonition-note"></a>
</div>
<div>
<p>If your <code>RISC_ZERO_VERIFIER</code> value is blank, this means that your rollup might be deployed on a base layer that does
not have a deployed RISC Zero zkVM verifier contract.
This means you might have to deploy your own verifier.
Always revise the RISC Zero <a href="https://dev.risczero.com/api/blockchain-integration/contracts/verifier">documentation</a>
to double-check verifier availability.</p>
</div>
</div>
<p>Once you have these values you'll need to save them for later use during migration.</p>
<h2 id="telemetry"><a class="header" href="#telemetry">Telemetry</a></h2>
<p>All Kailua binaries and commands support exporting telemetry data to an
<a href="https://opentelemetry.io/docs/collector/">OTLP Collector</a>.
The collector endpoint can be specified using the <code>--otlp-collector</code> parameter, or through specifying the
<code>OTLP_COLLECTOR</code> environment variable.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="parameters"><a class="header" href="#parameters">Parameters</a></h1>
<p>Before migrating to Kailua, you'll need to decide on a few setup parameters and note them down for later use during
the migration process.</p>
<h2 id="starting-block-number"><a class="header" href="#starting-block-number">Starting Block Number</a></h2>
<p>You'll need to pick a block number for Kailua to start sequencing from.
The sequencing state according to your <code>op-node</code> at the block you pick will be immediately finalized.
When you choose to enable withdrawal against Kailua sequencing proposals, your users will be able to start withdrawals
using this finalized state.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-tip"></a>
</div>
<div>
<p>You can postpone enabling withdrawals using Kailua at any later point in time after successful migration.</p>
</div>
</div>
<h2 id="proposal-output-count--output-block-span"><a class="header" href="#proposal-output-count--output-block-span">Proposal Output Count / Output Block Span</a></h2>
<p>Each sequencing proposal in Kailua must cover a fixed number of L2 blocks, which will determine how much data must be
published per proposal.
Consequently, configuring how many output commitments are published per proposal and how many L2 blocks are covered per
commitment will determine your proposer's DA costs for using Kailua and your validator's proving costs during dispute.</p>
<p>These commitments are published as Blobs, which means you should optimize your block span <code>S</code> to be <code>S = B * 4096 + 1</code>,
where <code>B</code> is the number of blobs required for a single proposal transaction (Ethereum currently limits a single block to
at most 6 blobs, i.e. <code>B &lt; 7</code>).</p>
<p>Subsequently, combining <code>S</code> with your rollup's block time determines how often your sequencer has to publish a proposal
to ensure the liveness of your chain.</p>
<div id="admonition-example" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-title">
<div class="admonition-title">
<div id="admonition-example-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-example"></a>
</div>
<div>
<p>Consider Optimism Mainnnet as an example, which has a block time of 2 seconds.
To keep its current average sequencing frequency of ~55 minutes, it only needs to publish ~1650 commitments per proposal.
To maximize the utilization of the extra blob published when proposing, OP Mainnet can relax its proposal rate to once
per 2 hours and 15 minutes.</p>
</div>
</div>
<h2 id="collateral-amount"><a class="header" href="#collateral-amount">Collateral Amount</a></h2>
<p>The collateral requirements for a sequencer in Kailua come in the form of a fixed amount to be deposited, independent of
how many sequencing proposals are in flight.
This is because a malicious Kailua proposer, and any faulty sequencing proposals it has published, is eliminated using
only a single fault proof.</p>
<p>The prover who submitted that fault proof consequently gets compensated with the faulty sequencer's staked collateral.
This collateral should at least cover the proving cost, but should also include a sizeable tip for the prover to
incentivize proving priority.
Our estimates put a worst-case proving cost using Bonsai for a single (OP Mainnet) block at $100 USD.</p>
<div id="admonition-example-1" class="admonition admonish-example" role="note" aria-labelledby="admonition-example-1-title">
<div class="admonition-title">
<div id="admonition-example-1-title">
<p>Example</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-example-1"></a>
</div>
<div>
<p>Currently, OP Mainnet requires 0.08 ETH (~$300) of collateral per proposal, and finalizes a proposal after at least 3.5
days if it is undisputed.
This means, at an average hourly rate of proposing, the proposer has <code>84 * 0.08 = 6.72</code> ETH (~$3700 USD) on average
locked up as collateral in the best case where no disputes take place.</p>
<p>Using Kailua, 0.08 ETH would be sufficient as the total collateral locked up by the proposer, even under the same finality
delay.
This would cover the worst-case proving cost in case of dispute, and, discounting transaction costs, leave a $200 tip.</p>
</div>
</div>
<h2 id="challenge-timeout"><a class="header" href="#challenge-timeout">Challenge Timeout</a></h2>
<p>The current implementation of Kailua does not yet have adaptive dispute periods based on congestion.
Consequently, you should keep your existing challenge timeout period.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-note"></a>
</div>
<div>
<p>If you wish to practically operate Kailua using only validity proofs, set this value to <code>31536000000000000</code> seconds
(i.e. 1 billion calendar years).</p>
</div>
</div>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-warning"></a>
</div>
<div>
<p>The duration of the challenge timeout should not be less than twice the length of your rollup's sequencing window.</p>
</div>
</div>
<h2 id="verifier-contract"><a class="header" href="#verifier-contract">Verifier Contract</a></h2>
<p>RISC Zero maintains a set of pre-deployed verifier contracts for its ZK proving system.
These contracts are regularly upgraded to support new releases of the prover, and also have a permissionless fail-safe
mechanism that anyone who can produce a proof-of-exploit can trigger to halt the verifier.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-note-1"></a>
</div>
<div>
<p>You must ensure that the chosen verifier contract supports your RISC Zero zkVM version.
Once a new zkVM version is released, there can be a delay in adding it to the router.</p>
</div>
</div>
<p>You have the choice of either using the already deployed verifier for your parent chain, or deploying and maintaining
your own verifier contracts, as described in the later sections.</p>
<h2 id="vanguard-advantage"><a class="header" href="#vanguard-advantage">Vanguard Advantage</a></h2>
<p>Kailua supports the designation of one proposer as a <em>Vanguard</em>, along with an <em>advantage time</em> for said proposer.
When set, this designation prevents any other proposer from publishing a proposal for a certain block height until
either the Vanguard has made a proposal for that height, or the advantage time granted to the Vanguard has passed.
The advantage time is counted down until after the Vanguard was allowed to publish a proposal.
The Vanguard still needs to lock up the necessary bond to make proposals.</p>
<div id="admonition-note-2" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-2-title">
<div class="admonition-title">
<div id="admonition-note-2-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-note-2"></a>
</div>
<div>
<p>Having a Vanguard that makes honest proposals within the advantage time guarantees the safety of the rollup.</p>
</div>
</div>
<div id="admonition-warning-1" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-1-title">
<div class="admonition-title">
<div id="admonition-warning-1-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-warning-1"></a>
</div>
<div>
<p>If the advantage time is unreasonably long, Vanguard downtime delays the liveness of the rollup.</p>
</div>
</div>
<p>This middleground enables rollups transitioning from a permissioned scheme to enjoy permissionless fault proofs in
Kailua with an added safety net.</p>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="parameters.html#admonition-success"></a>
</div>
<div>
<p>Once you've got your parameters all planned out, you're ready for the next step!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-contracts"><a class="header" href="#on-chain-contracts">On-chain Contracts</a></h1>
<p>In order to utilize Kailua, you'll need to deploy the Kailua dispute contracts, and configure your rollup to use them.
This process will require access to your rollup's 'Owner' and 'Guardian' wallets.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The steps required to upgrade your on-chain rollup contracts to support Kailua are as follows:</p>
<ol>
<li>(Optional) Deploy a RISC Zero Verifier contract set.
<ul>
<li>This can be skipped by using a pre-existing verifier contract.</li>
</ul>
</li>
<li>Deploy a <code>KailuaTreasury</code> and a <code>KailuaGame</code> contract with your configuration.</li>
<li>Initialize the <code>KailuaTreasury</code> contract to mark the start of sequencing under Kailua.</li>
<li>Update the rollup's <code>DisputeGameFactory</code> contract to use <code>KailuaGame</code> for sequencing proposals.
<ul>
<li>(Optional) Designate a Vanguard proposer.</li>
<li>(Optional) Enable withdrawals using finalized Kailua proposals.</li>
</ul>
</li>
</ol>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-tip"></a>
</div>
<div>
<p>The Kailua CLI has a <code>fast-track</code> command for automating the L1 transactions required to migrate to Kailua.
If the command does not yet support your configuration, you'll need to follow the manual steps in the next sub-sections.</p>
</div>
</div>
<div id="admonition-hint" class="admonition admonish-tip" role="note" aria-labelledby="admonition-hint-title">
<div class="admonition-title">
<div id="admonition-hint-title">
<p>Hint</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-hint"></a>
</div>
<div>
<p>You might find it useful to rehearse migration using a local devnet first.</p>
</div>
</div>
<h3 id="estimated-gas-costs"><a class="header" href="#estimated-gas-costs">Estimated Gas Costs</a></h3>
<p>The below table contains rounded-up gas cost estimates of various contract operations</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Contract</th><th style="text-align: left">Operation</th><th style="text-align: right">Gas</th><th>Notes</th></tr></thead><tbody>
<tr><td style="text-align: left">RiscZeroVerifierRouter</td><td style="text-align: left">deploy</td><td style="text-align: right">800K</td><td></td></tr>
<tr><td style="text-align: left">RiscZeroVerifierRouter</td><td style="text-align: left">addVerifier</td><td style="text-align: right">50K</td><td></td></tr>
<tr><td style="text-align: left">RiscZeroGroth16Verifier</td><td style="text-align: left">deploy</td><td style="text-align: right">1,300K</td><td></td></tr>
<tr><td style="text-align: left">RiscZeroMockVerifier</td><td style="text-align: left">deploy</td><td style="text-align: right">615K</td><td></td></tr>
<tr><td style="text-align: left">KailuaTreasury</td><td style="text-align: left">deploy</td><td style="text-align: right">5,200K</td><td></td></tr>
<tr><td style="text-align: left">KailuaTreasury</td><td style="text-align: left">propose</td><td style="text-align: right">400K</td><td>1 blob</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">deploy</td><td style="text-align: right">5,000K</td><td></td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveValidity</td><td style="text-align: right">375K</td><td>Groth16 proof</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveOutputFault</td><td style="text-align: right">415K</td><td>Groth16 + 1 KZG proofs</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveOutputFault</td><td style="text-align: right">470K</td><td>Groth16 + 2 KZG proofs</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">proveNullFault</td><td style="text-align: right">171K</td><td>1 KZG proof</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">120K</td><td>Undisputed</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">160K</td><td>1 fault</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">280K</td><td>2 faults</td></tr>
<tr><td style="text-align: left">KailuaGame</td><td style="text-align: left">resolve</td><td style="text-align: right">370K</td><td>3 faults</td></tr>
</tbody></table>
</div>
<h2 id="fast-track-migration"><a class="header" href="#fast-track-migration">Fast-track Migration</a></h2>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-info"></a>
</div>
<div>
<p>The fast-track migration tool is restricted to certain rollup deployment configurations.
As the tool is improved to accommodate more setups, these requirements will be relaxed.</p>
</div>
</div>
<h3 id="requirements"><a class="header" href="#requirements">Requirements</a></h3>
<ol>
<li>The "Owner" account must be a "Safe" contract instance controlled by a single private-key controlled wallet (EOA).</li>
<li>The "Guardian" account must be a private-key controlled wallet (EOA).</li>
<li>You must have access to the raw private key(s) above.</li>
</ol>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-tip-1"></a>
</div>
<div>
<p>You can skip the guardian key/account requirements if you do not wish to enable withdrawals against sequencing proposals
made by Kailua as part of the fast-track process via the <code>respect-kailua-proposals</code> flag.
You can enable withdrawals manually later using the <code>OptimismPortal2</code> contract.</p>
</div>
</div>
<h3 id="usage"><a class="header" href="#usage">Usage</a></h3>
<p>If all the above conditions are met, you can fast track the migration of your rollup to Kailua as follows:</p>
<pre><code class="language-shell">kailua-cli fast-track \
      --eth-rpc-url [YOUR_ETH_RPC_URL] \
      --op-geth-url [YOUR_OP_GETH_URL] \
      --op-node-url [YOUR_OP_NODE_URL] \
\
      --starting-block-number [YOUR_STARTING_BLOCK_NUMBER] \
      --proposal-output-count [YOUR_OUTPUTS_PER_PROPOSAL] \
      --output-block-span [YOUR_BLOCKS_PER_OUTPUT] \
\
      --collateral-amount [YOUR_COLLATERAL_AMOUNT] \
      --verifier-contract [RISC_ZERO_VERIFIER_ADDRESS] \
      --challenge-timeout [YOUR_CHALLENGE_PERIOD] \
\
      --deployer-key [YOUR_DEPLOYER_KEY] \
      --owner-key [YOUR_OWNER_KEY] \
      --guardian-key [YOUR_GUARDIAN_KEY] \
\
      --vanguard-address [YOUR_VANGUARD_ADDRESS] \
      --vanguard-advantage [YOUR_VANGUARD_ADVANTAGE] \
\
      --respect-kailua-proposals
</code></pre>
<div id="admonition-tip-2" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-2-title">
<div class="admonition-title">
<div id="admonition-tip-2-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-tip-2"></a>
</div>
<div>
<p>All the parameters above can be provided as environment variables.</p>
</div>
</div>
<h4 id="endpoints"><a class="header" href="#endpoints">Endpoints</a></h4>
<p>The first three parameters to this command are the L1 and L2 RPC endpoints:</p>
<ul>
<li><code>eth-rpc-url</code>: The endpoint for the parent chain.</li>
<li><code>op-geth-url</code>: The endpoint for the rollup execution client.</li>
<li><code>op-node-url</code>: The endpoint for the rollup consensus client.</li>
</ul>
<h4 id="sequencing-1"><a class="header" href="#sequencing-1">Sequencing</a></h4>
<p>The next three parameters configure sequencing:</p>
<ul>
<li><code>starting-block-number</code>: The rollup block number to immediately finalize and start sequencing from.</li>
<li><code>proposal-output-count</code>: The number of intermediate output commitments published per proposal.</li>
<li><code>output-block-span</code>: The number of rollup blocks each intermediate output commitment must cover.</li>
</ul>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-warning"></a>
</div>
<div>
<p>The sequencing state at the block <code>starting-block-number</code> as reported by the <code>op-node</code> will be finalized without delay.</p>
</div>
</div>
<h4 id="fault-proving"><a class="header" href="#fault-proving">Fault Proving</a></h4>
<p>The next three parameters configure fault proving:</p>
<ul>
<li><code>collateral-amount</code>: The amount of collateral (in wei) a sequencer has to stake before publishing proposals.</li>
<li><code>verifier-contract</code>: (Optional) The address of the existing RISC Zero verifier contract to use. If this argument is omitted, a new set of verifier contracts will be deployed.
<ul>
<li>If you wish to use an already existing verifier, you must provide this argument, even if the <code>config</code> command had located a verifier.</li>
<li>If you are deploying a new verifier contract and wish to support fake proofs generated in dev mode (insecure), make sure to set <code>RISC0_DEV_MODE=1</code> in your environment before invoking the <code>fast-track</code> command.</li>
</ul>
</li>
<li><code>challenge-timeout</code>: The timeout (in seconds) for a sequencing proposal to be contradicted.</li>
</ul>
<h4 id="ethereum-transactions"><a class="header" href="#ethereum-transactions">Ethereum Transactions</a></h4>
<p>The next three parameters are the private keys for the respective parent chain wallets:</p>
<ul>
<li><code>deployer-key</code>: Private key for the EOA used to deploy the new Kailua contracts.</li>
<li><code>owner-key</code>: Private key for the sole EOA controlling the Owner "Safe" contract.</li>
<li><code>guardian-key</code>: Private key for the EOA used as the "Guardian" of the optimism portal.</li>
</ul>
<h5 id="kms-support"><a class="header" href="#kms-support">KMS Support</a></h5>
<p>Instead of raw private keys, you can use either AWS or GCP for obtaining transaction signatures from a KMS.</p>
<ul>
<li>AWS: Specify a corresponding <code>[EOA]-aws-key-id</code> parameter. The remainder of the <a href="https://docs.aws.amazon.com/sdkref/latest/guide/creds-config-files.html">AWS configuration</a> is handled by the AWS SDK.
<ul>
<li>Example: <code>deployer-aws-key-id</code>.</li>
</ul>
</li>
<li>GCP: Specify the corresponding <code>[EOA]-google-project-id</code>, <code>[EOA]-google-location</code>, <code>[EOA]-google-keyring</code> and <code>[EOA]-google-key-name</code> parameters.
<ul>
<li>Example: <code>owner-google-project-id</code>, <code>owner-google-location</code>, <code>owner-google-keyring</code> and <code>owner-google-key-name</code>.</li>
</ul>
</li>
</ul>
<h4 id="vanguard-proposer"><a class="header" href="#vanguard-proposer">Vanguard Proposer</a></h4>
<p>The next two (optional) parameters define the Vanguard proposer advantage:</p>
<ul>
<li><code>vanguard-address</code>: The address of the designated Vanguard.</li>
<li><code>vanguard-advantage</code>: The amount of time (in seconds) to grant proposal exclusivity to the Vanguard.
<ul>
<li>If unspecified, this defaults to <code>1152921504606846975</code> (a practically indefinite advantage of 36 Billion years).</li>
</ul>
</li>
</ul>
<h4 id="withdrawals"><a class="header" href="#withdrawals">Withdrawals</a></h4>
<div id="admonition-bug" class="admonition admonish-bug" role="note" aria-labelledby="admonition-bug-title">
<div class="admonition-title">
<div id="admonition-bug-title">
<p>Bug</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-bug"></a>
</div>
<div>
<p>Changing the respected game type to Kailua may crash the <code>op-proposer</code> provided by optimism depending on its version.
This should be inconsequential because you'll need to run the Kailua proposer for further sequencing to take place anyway.</p>
</div>
</div>
<p>The final argument configures withdrawals in your rollup:</p>
<ul>
<li><code>respect-kailua-proposals</code>: (if present) will allow withdrawals using sequencing proposals finalized by Kailua.</li>
</ul>
<div id="admonition-done" class="admonition admonish-success" role="note" aria-labelledby="admonition-done-title">
<div class="admonition-title">
<div id="admonition-done-title">
<p>Done</p>
</div>
<a class="admonition-anchor-link" href="upgrade.html#admonition-done"></a>
</div>
<div>
<p>If you've successfully completed fast-track migration using the tool, you may now skip to the <a href="./operate.html">Off-chain page</a>.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-proof-verification"><a class="header" href="#on-chain-proof-verification">On-chain Proof Verification</a></h1>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-note"></a>
</div>
<div>
<p>If you've successfully performed fast-track migration, you do not need to follow the steps on this page.</p>
</div>
</div>
<p>The cryptographic fault proofs generated by Kailua require the existence of a RISC Zero verifier contract on the parent
chain (ethereum).</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-tip"></a>
</div>
<div>
<p>Use the Kailua CLI <code>config</code> command to retrieve the address of the officially deployed RISC Zero verifier for your
parent chain.
If one is available, you can use that address as your verifier and skip the steps in this section.</p>
</div>
</div>
<p>This section explains how to deploy a verifier suited to your needs, but you'll need to maintain it in case
of adopting any updates to Kailua that change the RISC Zero zkVM version used for proving.</p>
<h2 id="verifier-contracts"><a class="header" href="#verifier-contracts">Verifier Contracts</a></h2>
<p>This section describes the contracts that make up the on-chain proof verification pipeline.</p>
<h3 id="verifier-router"><a class="header" href="#verifier-router">Verifier Router</a></h3>
<p>The <a href="https://dev.risczero.com/api/blockchain-integration/contracts/verifier#verifier-router">RISCZeroVerifierRouter contract</a>
routes proofs from different sources to their correct verifier.
This allows your application (and Kailua) to leverage proofs generated using different zkVM versions, or through
the <a href="https://docs.beboundless.xyz/">Boundless proving network</a>, while delegating the complexity of managing the
verifier version to the router contract.</p>
<p>Depending on your needs, you may need to deploy and manage your own verifier instead of relying on the pre-deployed
router managed by RISC Zero.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-warning"></a>
</div>
<div>
<p>The verifier deployment made by Kailua does not yet utilize the <a href="https://github.com/risc0/risc0-ethereum/blob/release-1.2/contracts/src/RiscZeroVerifierEmergencyStop.sol">Emergency stop</a>
contract in the pre-deployed RISC Zero verifier, which allows anyone to permissionlessy disable a verification backend
in the router by proving a false statement.</p>
</div>
</div>
<h3 id="groth16-verifier"><a class="header" href="#groth16-verifier">Groth16 Verifier</a></h3>
<p>The <a href="https://github.com/risc0/risc0-ethereum/blob/release-1.2/contracts/src/groth16/RiscZeroGroth16Verifier.sol">RISCZeroGroth16Verifier</a>
only accepts valid Groth16 proofs generated using its hardcoded RISC Zero zkVM version determined by the control root
and id constructor parameters.
This verifier is intended to be deployed and then added as a possible backend to a router instead of being used directly on its own.
However, it is possible to call and use this verifier directly if the prover and verifier versions align.</p>
<h3 id="fake-proof-verifier-insecure"><a class="header" href="#fake-proof-verifier-insecure">Fake Proof Verifier (INSECURE)</a></h3>
<p>This verifier accepts fake proofs generated while running the RISC Zero zkVM in "dev mode".
It is only useful for testing out the zkVM in a development environment without being delayed by proving time.</p>
<div id="admonition-danger" class="admonition admonish-danger" role="note" aria-labelledby="admonition-danger-title">
<div class="admonition-title">
<div id="admonition-danger-title">
<p>Danger</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-danger"></a>
</div>
<div>
<p>Do not use the fake proof verifier anywhere near production.</p>
</div>
</div>
<h2 id="deployment"><a class="header" href="#deployment">Deployment</a></h2>
<p>This section will walk you through creating your own verifier deployment.
The commands below will be using Foundry's <code>forge</code> and <code>cast</code> utilities, which you should have installed as part of the
foundry <a href="quickstart.html#prerequisites">prerequisite</a>.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-note-1"></a>
</div>
<div>
<p>The below foundry commands expect both a parameter that determines the wallet to use and the rpc endpoint of the parent
chain.
You will have to add these two parameters manually to every command below.
For more information, refer to <code>forge create --help</code>, <code>cast call --help</code>, and <code>cast send --help</code></p>
</div>
</div>
<p>First, change your working directory to <code>crates/contracts/foundry</code> for <code>forge</code> to work:</p>
<pre><code class="language-shell">cd crates/contracts/foundry
</code></pre>
<h3 id="router"><a class="header" href="#router">Router</a></h3>
<pre><code class="language-solidity">constructor(address admin) Ownable(admin)
</code></pre>
<p>The <code>RISCZeroVerifierRouter</code> constructor requires a single <code>admin</code> address, which is an account authorised to modify
the router in one of two ways after it is deployed:</p>
<ol>
<li>Add a new verification backend through <code>addVerifier</code>:</li>
<li>Permanently disable a verification backend through <code>removeVerifier</code>:</li>
</ol>
<p>To deploy a new router, invoke the following command</p>
<pre><code class="language-shell">forge create RiscZeroVerifierRouter --constructor-args [ADMIN_ADDRESS]
</code></pre>
<p>On success, you should see output similar to the following:</p>
<pre><code>Deployer: [YOUR_DEPLOYER_WALLET_ADDRESS]
Deployed to: [YOUR_DEPLOYED_ROUTER_CONTRACT]
Transaction hash: [YOUR_DEPLOYMENT_TRANSACTION_HASH]
</code></pre>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-success"></a>
</div>
<div>
<p>Make sure to note down the <code>YOUR_DEPLOYED_ROUTER_CONTRACT</code> address.
We will use this in the following commands when adding proving backends.
The router cannot verify any proofs on its own.</p>
</div>
</div>
<h3 id="groth16-verifier-1"><a class="header" href="#groth16-verifier-1">Groth16 Verifier</a></h3>
<p>The Groth16 verifier validates stand-alone cryptographic proofs generated using the RISC Zero zkVM and compressed using
the RISC Zero STARK-to-SNARK wrapper.</p>
<p>This verifier can be deployed as follows using the control root and id from the <code>kailua-cli config</code> command output:</p>
<pre><code class="language-shell">forge create RiscZeroGroth16Verifier --constructor-args \ 
  [YOUR_CONTROL_ROOT] \
  [YOUR_CONTROL_ID]
</code></pre>
<p>The output should again give you the relevant addresses:</p>
<pre><code>Deployer: [YOUR_DEPLOYER_WALLET_ADDRESS]
Deployed to: [YOUR_DEPLOYED_GROTH16_VERIFIER_CONTRACT]
Transaction hash: [YOUR_DEPLOYMENT_TRANSACTION_HASH]
</code></pre>
<p>We again need to query this verifier's selector:</p>
<pre><code class="language-shell">cast call [YOUR_DEPLOYED_GROTH16_VERIFIER_CONTRACT] \
  "SELECTOR() returns (bytes4)"
</code></pre>
<p>Yielding another 4-byte selector:</p>
<pre><code>0xc101b42b
</code></pre>
<p>And finally we need to add this verifier to our router:</p>
<pre><code class="language-shell">cast send \
  [YOUR_DEPLOYED_ROUTER_CONTRACT] \
  "addVerifier(bytes4 selector, address verifier)" \
  [YOUR_GROTH16_SELECTOR] \
  [YOUR_DEPLOYED_GROTH16_VERIFIER_CONTRACT]
</code></pre>
<div id="admonition-success-1" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-1-title">
<div class="admonition-title">
<div id="admonition-success-1-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="verifier.html#admonition-success-1"></a>
</div>
<div>
<p>You now have a RISC Zero verifier contract!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-dispute-resolution"><a class="header" href="#on-chain-dispute-resolution">On-chain Dispute Resolution</a></h1>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-note"></a>
</div>
<div>
<p>If you've successfully performed fast-track migration, you do not need to follow the steps on this page.</p>
</div>
</div>
<p>Kailua's on-chain dispute mechanism is powered by its own custom contracts that define a novel ZK dispute game.
Each rollup has to deploy its own pair of dispute resolution contracts, and this section will guide you through that
process.</p>
<p>The commands below will be using Foundry's <code>forge</code> and <code>cast</code> utilities, which you should have installed as part of the
foundry <a href="quickstart.html#prerequisites">prerequisite</a>.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-note-1"></a>
</div>
<div>
<p>The below foundry commands expect both a parameter that determines the wallet to use and the rpc endpoint of the parent
chain.
You will have to add these two parameters manually to every command below.
For more information, refer to <code>forge create --help</code>, <code>cast call --help</code>, and <code>cast send --help</code></p>
</div>
</div>
<p>First, change your working directory to <code>crates/contracts/foundry</code> for <code>forge</code> to work:</p>
<pre><code class="language-shell">cd crates/contracts/foundry
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-warning"></a>
</div>
<div>
<p>The parameters used to deploy the contracts below are immutable.
Any changes will require redeployment of both the <code>KailuaGame</code> and <code>KailuaTreasury</code> contracts, along with a repetition of
the steps in the latter sections.
The same <code>KailuaTreasury</code> deployment <strong>should NOT</strong> be reused with multiple <code>KailuaGame</code> deployments, unless they were
<strong>never</strong> used to publish a proposal (except for the last <code>KailuaGame</code> deployment used).</p>
</div>
</div>
<h2 id="kailuatreasury"><a class="header" href="#kailuatreasury">KailuaTreasury</a></h2>
<pre><code class="language-solidity">constructor(
  IRiscZeroVerifier _verifierContract,
  bytes32 _imageId,
  bytes32 _configHash,
  uint256 _proposalOutputCount,
  uint256 _outputBlockSpan,
  GameType _gameType,
  OptimismPortal2 _optimismPortal,
  Claim _rootClaim,
  uint64 _l2BlockNumber
)
</code></pre>
<p>This contract stores the collateral bonds required for sequencers to publish their proposal, and also stores the first
sequencing proposal for Kailua as a fault dispute game in your rollup.</p>
<div id="admonition-note-2" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-2-title">
<div class="admonition-title">
<div id="admonition-note-2-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-note-2"></a>
</div>
<div>
<p>Each published proposal on the L1 will cover <code>proposalOutputCount × outputBlockSpan</code> L2 blocks, and require
publication of <code>proposalOutputCount</code> 32-byte commitments on the DA layer.</p>
</div>
</div>
<h2 id="anchor-point"><a class="header" href="#anchor-point">Anchor Point</a></h2>
<p>First, you will need to choose the rollup block number from which Kailua sequencing should start.
Then, you need to query your <code>op-node</code> for the <code>outputRoot</code> at that block number as follows:</p>
<pre><code class="language-shell">cast rpc --rpc-url [YOUR_OP_NODE_ADDRESS] \
  "optimism_outputAtBlock" \
  $(cast 2h [YOUR_STARTING_L2_BLOCK_NUMBER])
</code></pre>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-tip"></a>
</div>
<div>
<p>You can quickly filter through the response for <code>outputRoot</code> by piping it to <code>jq -r .outputRoot</code></p>
</div>
</div>
<h3 id="deployment-1"><a class="header" href="#deployment-1">Deployment</a></h3>
<p>Deployment of this contract is via the command below:</p>
<pre><code class="language-shell">forge create KailuaTreasury --constructor-args \
  [YOUR_RISC_ZERO_VERIFIER] \
  [YOUR_FPVM_IMAGE_ID] \
  [YOUR_ROLLUP_CONFIG_HASH] \
  [YOUR_PROPOSAL_OUTPUT_COUNT] \
  [YOUR_OUTPUT_BLOCK_SPAN] \
  [YOUR_KAILUA_GAME_TYPE] \
  [YOUR_OPTIMISM_PORTAL] \
  [YOUR_OUTPUT_ROOT_CLAIM] \
  [YOUR_L2_BLOCK_NUMBER]
</code></pre>
<p>Deploying the contract successfully should yield similar output to the following:</p>
<pre><code>Deployer: [YOUR_DEPLOYER_WALLET_ADDRESS]
Deployed to: [YOUR_DEPLOYED_TREASURY_CONTRACT]
Transaction hash: [YOUR_DEPLOYMENT_TRANSACTION_HASH]
</code></pre>
<p>Take note of the contract address since we'll need it later.</p>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-tip-1"></a>
</div>
<div>
<p>If your rollup <code>owner</code> account is controlled by a <code>Safe</code> contract, or some other multi-sig contract, you can use
<code>cast calldata</code> to get the necessary input that your wallet contract should forward.</p>
<ul>
<li>You can use the <a href="https://github.com/safe-global/safe-cli">safe cli</a> to issue the necessary <code>send-custom</code> commands.</li>
<li>You can use the <a href="https://app.safe.global/home">safe gui</a> web app to create the necessary transactions.</li>
</ul>
</div>
</div>
<h2 id="kailuagame"><a class="header" href="#kailuagame">KailuaGame</a></h2>
<pre><code class="language-solidity">constructor(
  IKailuaTreasury _kailuaTreasury,
  IRiscZeroVerifier _verifierContract,
  uint256 _genesisTimeStamp,
  uint256 _l2BlockTime,
  Duration _maxClockDuration
)
</code></pre>
<p>This contract is used by the optimism <code>DisputeGameFactory</code> to instantiate every Kailua sequencing proposal after the
initial one in the <code>KailuaTreasury</code>.
Deployment is fairly similar to the treasury via the command below:</p>
<pre><code class="language-shell">forge create KailuaGame --evm-version cancun --constructor-args \
  [YOUR_DEPLOYED_TREASURY_CONTRACT] \
  [YOUR_GENESIS_TIMESTAMP] \
  [YOUR_BLOCK_TIME] \
  [YOUR_MAX_CLOCK_DURATION]
</code></pre>
<div id="admonition-note-3" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-3-title">
<div class="admonition-title">
<div id="admonition-note-3-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-note-3"></a>
</div>
<div>
<p>The above forge command requires the <code>--evm-version cancun</code> argument.</p>
</div>
</div>
<p>Deploying the contract successfully should yield similar output to the following:</p>
<pre><code>Deployer: [YOUR_DEPLOYER_WALLET_ADDRESS]
Deployed to: [YOUR_DEPLOYED_GAME_CONTRACT]
Transaction hash: [YOUR_DEPLOYMENT_TRANSACTION_HASH]
</code></pre>
<p>Note down this contract's address, we'll use it later.
There is no configuration needed for this contract.</p>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="dispute.html#admonition-success"></a>
</div>
<div>
<p>You now have two Kailua dispute resolution contracts tailored to your rollup and ZK verifier!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-state-anchoring"><a class="header" href="#on-chain-state-anchoring">On-chain State Anchoring</a></h1>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-note"></a>
</div>
<div>
<p>If you've successfully performed fast-track migration, you do not need to follow the steps on this page.</p>
</div>
</div>
<p>In this section you will be integrating the <code>KailuaTreasury</code> contract with your rollup's <code>DisputeGameFactory</code>.
This will finalize the initial sequencing proposal from which Kailua will start.</p>
<p>The commands below will be using Foundry's <code>cast</code> utility, which you should have installed as part of the
foundry <a href="quickstart.html#prerequisites">prerequisite</a>.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-note-1"></a>
</div>
<div>
<p>The below foundry commands expect both a parameter that determines the wallet to use and the rpc endpoint of the parent
chain.
You will have to add these two parameters manually to every command below.
For more information, refer to <code>cast call --help</code>, and <code>cast send --help</code></p>
</div>
</div>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-tip"></a>
</div>
<div>
<p>If your rollup <code>owner</code> account is controlled by a <code>Safe</code> contract, or some other multi-sig contract, you can use
<code>cast calldata</code> to get the necessary input that your wallet contract should forward.</p>
</div>
</div>
<h2 id="clear-dgf-kailua-bond"><a class="header" href="#clear-dgf-kailua-bond">Clear DGF Kailua Bond</a></h2>
<p>Optimism's <code>DisputeGameFactory</code> is design to require a bond value for each sequencing proposal.
The <code>KailuaTreasury</code> instead requires a constant bond value for a sequencer to make any number of proposals.
To ensure that the Kailua sequencer operates as expected, we will need to set this value to zero for Kailua proposals
if it is non-zero.
You can check the value as follows:</p>
<pre><code class="language-shell">cast call [YOUR_DISPUTE_GAME_FACTORY] \
  "initBonds(uint32) returns (uint256)" \
  [YOUR_KAILUA_GAME_TYPE]
</code></pre>
<p>If the returned value is non-zero, you must reset it through <code>setInitBond</code> using your rollup <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send [YOUR_DISPUTE_GAME_FACTORY] \
  "setInitBond(uint32, uint256)" \
  [YOUR_KAILUA_GAME_TYPE] \
  0
</code></pre>
<h2 id="set-kailuatreasury-implementation"><a class="header" href="#set-kailuatreasury-implementation">Set KailuaTreasury Implementation</a></h2>
<p>The next step is to update the implementation for the Kailua game type stored in the <code>DisputeGameFactory</code> contract to
point towards the <code>KailuaTreasury</code> contract deployed in the last section.
This can be done as follows using your <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send [YOUR_DISPUTE_GAME_FACTORY] \
  "setImplementation(uint32, address)" \
  [YOUR_KAILUA_GAME_TYPE] \
  [YOUR_DEPLOYED_TREASURY_CONTRACT]
</code></pre>
<h2 id="anchor-instantiation"><a class="header" href="#anchor-instantiation">Anchor Instantiation</a></h2>
<p>Once the implementation is set, the next step is to create a dispute game instance using the treasury.
This step is only to be done once in order to create a starting point for sequencing using Kailua.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-warning"></a>
</div>
<div>
<p>This step will publish and immediately resolve (finalize) a single sequencing proposal with no chance for dispute.</p>
</div>
</div>
<p>Recall the rollup block number and its output root from the deployment in the previous section.</p>
<pre><code class="language-shell">cast rpc --rpc-url [YOUR_OP_NODE_ADDRESS] \
  "optimism_outputAtBlock" \
  $(cast 2h [YOUR_STARTING_L2_BLOCK_NUMBER])
</code></pre>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-tip-1"></a>
</div>
<div>
<p>You can quickly filter through the response for <code>outputRoot</code> by piping it to <code>jq -r .outputRoot</code></p>
</div>
</div>
<p>Once you have the <code>outputRoot</code> value you wish to start sequencing from, the next step is to call <code>propose</code> on <code>KailuaTreasury</code> using the <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send [YOUR_DEPLOYED_TREASURY_CONTRACT] \
  "propose(bytes32, bytes)" \
  [YOUR_OUTPUT_ROOT] \
  $(cast abi-encode --packed "f(uint64,address)" [YOUR_STARTING_L2_BLOCK_NUMBER] [YOUR_DEPLOYED_TREASURY_CONTRACT])
</code></pre>
<div id="admonition-note-2" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-2-title">
<div class="admonition-title">
<div id="admonition-note-2-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-note-2"></a>
</div>
<div>
<p>The above cast abi-encode command requires the <code>--packed</code> argument.</p>
</div>
</div>
<p>To get the address of this new game instance, use the <code>games</code> function on the <code>DisputeGameFactory</code>:</p>
<pre><code class="language-shell">cast call [YOUR_DISPUTE_GAME_FACTORY] \
  "games(uint32, bytes32, bytes) returns (address, uint64)" \
  [YOUR_KAILUA_GAME_TYPE] \
  [YOUR_OUTPUT_ROOT] \
  $(cast abi-encode --packed "f(uint64,address)" [YOUR_STARTING_L2_BLOCK_NUMBER] [YOUR_DEPLOYED_TREASURY_CONTRACT])
</code></pre>
<p>With this instance address, the last step is to call <code>resolve()</code> on it using the <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send [YOUR_GAME_INSTANCE_ADDRESS] \
  "resolve()"
</code></pre>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="treasury.html#admonition-success"></a>
</div>
<div>
<p>You have now set a sequencing starting point for Kailua!</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="on-chain-sequencing-proposal"><a class="header" href="#on-chain-sequencing-proposal">On-chain Sequencing Proposal</a></h1>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-note"></a>
</div>
<div>
<p>If you've successfully performed fast-track migration, you do not need to follow the steps on this page.</p>
</div>
</div>
<p>In this section you will be integrating the <code>KailuaGame</code> contract with your rollup's <code>DisputeGameFactory</code>.
This will allow Kailua sequencers to submit new proposals!</p>
<p>The commands below will be using Foundry's <code>cast</code> utility, which you should have installed as part of the
foundry <a href="quickstart.html#prerequisites">prerequisite</a>.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-note-1"></a>
</div>
<div>
<p>The below foundry commands expect both a parameter that determines the wallet to use and the rpc endpoint of the parent
chain.
You will have to add these two parameters manually to every command below.
For more information, refer to <code>cast call --help</code>, and <code>cast send --help</code></p>
</div>
</div>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-tip"></a>
</div>
<div>
<p>If your rollup <code>owner</code> account is controlled by a <code>Safe</code> contract, or some other multi-sig contract, you can use
<code>cast calldata</code> to get the necessary input that your wallet contract should forward.</p>
</div>
</div>
<h2 id="set-collateral-requirement"><a class="header" href="#set-collateral-requirement">Set Collateral Requirement</a></h2>
<p>Before allowing sequencing proposals past the anchor state, you'll need to set the bond value (in wei) required for sequencers.
This is done by calling the <code>setParticipationBond</code> function on the treasury contract using the <code>owner</code> wallet for your
rollup.</p>
<p>For example, if your bond value is 12 eth, first convert this to wei using <code>cast</code>:</p>
<pre><code class="language-shell">cast to-wei 12
</code></pre>
<pre><code>12000000000000000000
</code></pre>
<p>Then, configure the bond as follows using the rollup <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send \
  [YOUR_DEPLOYED_TREASURY_CONTRACT] \
  "setParticipationBond(uint256 amount)" \
  12000000000000000000
</code></pre>
<h2 id="set-kailuagame-implementation"><a class="header" href="#set-kailuagame-implementation">Set KailuaGame Implementation</a></h2>
<p>The next step is to update the implementation for the Kailua game type stored in the <code>DisputeGameFactory</code> contract to
point towards the <code>KailuaGame</code> contract deployed previously.
This can be done as follows using your <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send [YOUR_DISPUTE_GAME_FACTORY] \
  "setImplementation(uint32, address)" \
  [YOUR_KAILUA_GAME_TYPE] \
  [YOUR_DEPLOYED_GAME_CONTRACT]
</code></pre>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-success"></a>
</div>
<div>
<p>You have now enabled Kailua sequencing proposals to be published!</p>
</div>
</div>
<h2 id="designate-vanguard-optional"><a class="header" href="#designate-vanguard-optional">Designate Vanguard (Optional)</a></h2>
<p>To assign a Vanguard, you'll need to call <code>assignVanguard</code> on the anchoring game instance you created.
This can be done as follows using your <code>owner</code> wallet:</p>
<pre><code class="language-shell">cast send [YOUR_GAME_INSTANCE_ADDRESS] \
  "assignVanguard(address, uint64)" \
  [YOUR_VANGUARD_ADDRESS] \
  [YOUR_VANGUARD_ADVANTAGE]
</code></pre>
<div id="admonition-success-1" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-1-title">
<div class="admonition-title">
<div id="admonition-success-1-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-success-1"></a>
</div>
<div>
<p>You have now designated a Vanguard for Kailua sequencing proposals!</p>
</div>
</div>
<h2 id="enable-withdrawals-optional"><a class="header" href="#enable-withdrawals-optional">Enable Withdrawals (Optional)</a></h2>
<p>To enable your users to perform withdrawals using Kailua sequencing proposals, you will need to call
<code>setRespectedGameType</code> on your <code>OptimismPortal2</code> contract using your <code>guardian</code> wallet.</p>
<div id="admonition-bug" class="admonition admonish-bug" role="note" aria-labelledby="admonition-bug-title">
<div class="admonition-title">
<div id="admonition-bug-title">
<p>Bug</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-bug"></a>
</div>
<div>
<p>This action may cause your optimism <code>op-proposer</code> agent to crash.
However, you will later run the Kailua proposer agent for sequencing anyway.</p>
</div>
</div>
<pre><code class="language-shell">cast send [YOUR_OPTIMISM_PORTAL] \
  "setRespectedGameType(uint32)" \
  [YOUR_KAILUA_GAME_TYPE]
</code></pre>
<div id="admonition-success-2" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-2-title">
<div class="admonition-title">
<div id="admonition-success-2-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="game.html#admonition-success-2"></a>
</div>
<div>
<p>You have now enabled withdrawals using resolved (finalized) Kailua sequencing proposals!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="off-chain-agents"><a class="header" href="#off-chain-agents">Off-chain Agents</a></h1>
<p>Once your chain contracts are upgraded to integrate Kailua, this section describes what you need to do for sequencing
and fault proving to take place in your rollup using Kailua.
Kailua provides two agents to take on the role of the standard Optimism <code>op-proposer</code> and <code>op-challenger</code> agents.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="operate.html#admonition-tip"></a>
</div>
<div>
<p>If you will only be using Kailua for sequencing (and withdrawals), you should terminate your <code>op-proposer</code> and
<code>op-challenger</code> agent processes if you plan on reusing their wallets to avoid transaction errors.</p>
</div>
</div>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="operate.html#admonition-warning"></a>
</div>
<div>
<p>Just like their optimism counterparts, the Kailua agents must remain online and their wallets sufficiently funded to
guarantee the safety and liveness of your rollup.</p>
</div>
</div>
<div id="admonition-danger" class="admonition admonish-danger" role="note" aria-labelledby="admonition-danger-title">
<div class="admonition-title">
<div id="admonition-danger-title">
<p>Danger</p>
</div>
<a class="admonition-anchor-link" href="operate.html#admonition-danger"></a>
</div>
<div>
<p>Without a Vanguard, sequencing in Kailua is fully permissionless at all time.
Anyone can run these Kailua agents for your rollup and publish proposals when possible.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kailua-proposer"><a class="header" href="#kailua-proposer">Kailua Proposer</a></h1>
<p>The Kailua proposer agent takes care of publishing your local <code>op-node</code>'s view of transaction sequencing to Ethereum in
a format that is compatible with the Kailua ZK fault dispute mechanism.
It also attempts to resolve any finalizeable proposals.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>Starting the Kailua proposer is straightforward:</p>
<pre><code class="language-shell">kailua-cli propose \
  --eth-rpc-url [YOUR_ETH_RPC_URL] \
  --beacon-rpc-url [YOUR_BEACON_RPC_URL] \
  --op-geth-url [YOUR_OP_GETH_URL] \
  --op-node-url [YOUR_OP_NODE_URL] \
  --data-dir [YOUR_PROPOSER_DATA_CACHE_PATH] \
  --proposer-key [YOUR_PROPOSER_WALLET_PRIVATE_KEY] \
  --txn-timeout [YOUR_TRANSACTION_TIMEOUT_SECONDS] \
  --exec-gas-premium [YOUR_EXECUTION_GAS_PREMIUM_PERCENTAGE] \
  --blob-gas-premium [YOUR_BLOB_GAS_PREMIUM_PERCENTAGE]
</code></pre>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="proposer.html#admonition-tip"></a>
</div>
<div>
<p>All the parameters above can be provided as environment variables.</p>
</div>
</div>
<h3 id="endpoints-1"><a class="header" href="#endpoints-1">Endpoints</a></h3>
<p>The first four arguments specify the endpoints that the proposer should use for sequencing:</p>
<ul>
<li><code>eth-rpc-url</code>: The parent chain (ethereum) endpoint for reading/publishing proposals.</li>
<li><code>beacon-rpc-url</code>: The DA layer (eth-beacon chain) endpoint for retrieving published proposal data.</li>
<li><code>op-geth-url</code>: The rollup <code>op-geth</code> endpoint to read configuration data from.</li>
<li><code>op-node-url</code>: The rollup <code>op-node</code> endpoint to read sequencing proposals from.</li>
</ul>
<h3 id="cache-directory-optional"><a class="header" href="#cache-directory-optional">Cache Directory (Optional)</a></h3>
<p>The proposer saves data to disk as it tracks on-chain proposals.
This allows it to restart quickly without requesting a lot of old on-chain data if terminated.</p>
<ul>
<li><code>data-dir</code>: Optional directory to save data to.
<ul>
<li>If unspecified, a tmp directory is created.</li>
</ul>
</li>
</ul>
<h3 id="wallet"><a class="header" href="#wallet">Wallet</a></h3>
<p>The proposer requires a funded wallet to be able to publish new sequencing proposals on-chain.</p>
<ul>
<li><code>proposer-key</code>: The private key for the proposer wallet.</li>
</ul>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="proposer.html#admonition-tip-1"></a>
</div>
<div>
<p><code>proposer-key</code> can be replaced with the corresponding AWS/GCP parameters as described <a href="upgrade.html#kms-support">here</a>.</p>
</div>
</div>
<div id="admonition-danger" class="admonition admonish-danger" role="note" aria-labelledby="admonition-danger-title">
<div class="admonition-title">
<div id="admonition-danger-title">
<p>Danger</p>
</div>
<a class="admonition-anchor-link" href="proposer.html#admonition-danger"></a>
</div>
<div>
<p>The Kailua proposer wallet is critical for security.
You must keep your proposer's wallet well funded to guarantee the safety and liveness of your rollup.</p>
</div>
</div>
<h3 id="transactions"><a class="header" href="#transactions">Transactions</a></h3>
<p>You can control transaction publication through the three following parameters:</p>
<ul>
<li><code>txn-timeout</code>: A timeout in seconds for transaction broadcast (default 120)</li>
<li><code>exec-gas-premium</code>: An added premium percentage to estimated execution gas fees (Default 25)</li>
<li><code>blob-gas-premium</code>: An added premium percentage to estimated blob gas fees (Default 25).</li>
</ul>
<p>The premium parameters increase the internally estimated fees by the specified percentage.</p>
<h3 id="upgrades"><a class="header" href="#upgrades">Upgrades</a></h3>
<p>If you re-deploy the KailuaTreasury/KailuaGame contracts to upgrade your fault proof system, you will need to restart
your proposer (and validator).
By default, the proposer (and validator) will use the latest contract deployment available upon start up, and ignore any
proposals not made using them.
If you wish to start a proposer for a past deployment, you can explicitly specify the deployed KailuaGame contract
address using the optional <code>kailua-game-implementation</code> parameter.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="proposer.html#admonition-note"></a>
</div>
<div>
<p>When running on an older deployment, the proposer will not create any new proposals, but will finalize any old ones once
possible.</p>
</div>
</div>
<h2 id="proposal-data-availability"><a class="header" href="#proposal-data-availability">Proposal Data Availability</a></h2>
<p>By default, Kailua uses the beacon chain to publish blobs that contain the extra data required for proposals.</p>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="proposer.html#admonition-info"></a>
</div>
<div>
<p>Alternative DA layers for this process will be supported in the future.</p>
</div>
</div>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="proposer.html#admonition-success"></a>
</div>
<div>
<p>Running <code>kailua-cli propose</code> should now publish Kailua sequencing proposals for your rollup!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kailua-validator"><a class="header" href="#kailua-validator">Kailua Validator</a></h1>
<p>The Kailua validator watches your rollup for sequencing proposals that contradict each other and generates a ZK fault
proof to settle the dispute between them.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-note"></a>
</div>
<div>
<p>The Kailua validator agent requires access to an archive <code>op-geth</code> rollup node to retrieve data during proof generation.
Node software other than <code>op-geth</code> is not as reliable for the necessary <code>debug</code> namespace rpc calls.</p>
</div>
</div>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<p>Starting the Kailua validator is straightforward:</p>
<pre><code class="language-shell">kailua-cli validate \
  --eth-rpc-url [YOUR_ETH_RPC_URL] \
  --beacon-rpc-url [YOUR_BEACON_RPC_URL] \
  --op-geth-url [YOUR_OP_GETH_URL] \
  --op-node-url [YOUR_OP_NODE_URL] \
  --data-dir [YOUR_VALIDATOR_DATA_CACHE_PATH] \
  --validator-key [YOUR_PROPOSER_WALLET_PRIVATE_KEY] \
  --payout-recipient-address [YOUR_FAULT_PROOF_PAYOUT_RECIPIENT] \
  --txn-timeout [YOUR_TRANSACTION_TIMEOUT_SECONDS] \
  --exec-gas-premium [YOUR_EXECUTION_GAS_PREMIUM_PERCENTAGE]
</code></pre>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-tip"></a>
</div>
<div>
<p>All the parameters in this section can be provided as environment variables.</p>
</div>
</div>
<h3 id="endpoints-2"><a class="header" href="#endpoints-2">Endpoints</a></h3>
<p>The first four arguments specify the endpoints that the validator should use to generate fault proofs:</p>
<ul>
<li><code>eth-rpc-url</code>: The parent chain (ethereum) endpoint for reading proposals and publishing proofs.</li>
<li><code>beacon-rpc-url</code>: The DA layer (eth-beacon chain) endpoint for retrieving rollup data.</li>
<li><code>op-geth-url</code>: The (archive) rollup <code>op-geth</code> endpoint to read fault proving witness data from.</li>
<li><code>op-node-url</code>: The rollup <code>op-node</code> endpoint to read sequencing proposals from.</li>
</ul>
<h3 id="cache-directory-optional-1"><a class="header" href="#cache-directory-optional-1">Cache Directory (Optional)</a></h3>
<p>The validator saves data to disk as it tracks on-chain proposals.
This allows it to restart quickly without requesting a lot of old on-chain data if terminated.</p>
<ul>
<li><code>data-dir</code>: Optional directory to save data to.
<ul>
<li>If unspecified, a tmp directory is created.</li>
</ul>
</li>
</ul>
<h3 id="prover"><a class="header" href="#prover">Prover</a></h3>
<p>To create a fault proof, the validator invokes the <code>kailua-cli</code> binary with the <code>prove</code> command.</p>
<ul>
<li><code>kailua-cli</code>: The path to the binary to call for proof generation.
Defaults to the path of the invoked <code>kailua-cli</code> executable.</li>
</ul>
<h3 id="wallet-1"><a class="header" href="#wallet-1">Wallet</a></h3>
<p>The validator requires a funded wallet to be able to publish fault proofs on chain, and an (optional) alternative address
to direct fault proof submission payouts towards</p>
<ul>
<li><code>validator-key</code>: The private key for the validator wallet.</li>
<li><code>payout-recipient-address</code>: The ethereum address to use as the recipient of fault proof payouts.</li>
</ul>
<div id="admonition-tip-1" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-1-title">
<div class="admonition-title">
<div id="admonition-tip-1-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-tip-1"></a>
</div>
<div>
<p><code>validator-key</code> can be replaced with the corresponding AWS/GCP parameters as described <a href="upgrade.html#kms-support">here</a>.</p>
</div>
</div>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-warning"></a>
</div>
<div>
<p>You must keep your validator's wallet well funded to guarantee the liveness of your rollup and prevent faulty proposals
from delaying the finality of honest sequencing proposals.</p>
</div>
</div>
<div id="admonition-success" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-title">
<div class="admonition-title">
<div id="admonition-success-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-success"></a>
</div>
<div>
<p>Running <code>kailua-cli validate</code> should monitor your rollup for any disputes and generate the required proofs!</p>
</div>
</div>
<h3 id="transactions-1"><a class="header" href="#transactions-1">Transactions</a></h3>
<p>You can control transaction publication through the two following parameters:</p>
<ul>
<li><code>txn-timeout</code>: A timeout in seconds for transaction broadcast (default 120)</li>
<li><code>exec-gas-premium</code>: An added premium percentage to estimated execution gas fees (Default 25)</li>
</ul>
<p>The premium parameter increases the internally estimated fees by the specified percentage.</p>
<h3 id="upgrades-1"><a class="header" href="#upgrades-1">Upgrades</a></h3>
<p>If you re-deploy the KailuaTreasury/KailuaGame contracts to upgrade your fault proof system, you will need to restart
your validator (and proposer).
By default, the validator (and proposer) will use the latest contract deployment available upon start up, and ignore any
proposals not made using them.
If you wish to start a validator for a past deployment, you can explicitly specify the deployed KailuaGame contract
address using the optional <code>kailua-game-implementation</code> parameter.</p>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-note-1"></a>
</div>
<div>
<p>The validator will not generate any proofs for proposals made using a different deployment than the one used at start up.</p>
</div>
</div>
<h2 id="validity-proof-generation"><a class="header" href="#validity-proof-generation">Validity Proof Generation</a></h2>
<p>Instead of only generating fault proofs, the validator can be instructed to generate a validity proof for every correct
canonical proposal it encounters to fast-forward finality until a specified block height.
This is configured using the below parameter:</p>
<ul>
<li><code>fast-forward-target</code>: The L2 block height until which validity proofs should be computed.</li>
</ul>
<div id="admonition-note-2" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-2-title">
<div class="admonition-title">
<div id="admonition-note-2-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-note-2"></a>
</div>
<div>
<p>To indefinitely power a validity-proof only rollup, this value can be specified to the maximum 64-bit value of
<code>18446744073709551615</code>.</p>
</div>
</div>
<div id="admonition-success-1" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-1-title">
<div class="admonition-title">
<div id="admonition-success-1-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-success-1"></a>
</div>
<div>
<p>Running <code>kailua-cli validate</code> with the above parameter should generate a validity proof as soon as a correct proposal
is made by an honest proposer!</p>
</div>
</div>
<h2 id="delegated-proof-generation"><a class="header" href="#delegated-proof-generation">Delegated Proof Generation</a></h2>
<p>Extra parameters and environment variables can be specified to determine exactly where the RISC Zero proof
generation takes place.
Running using only the parameters above will generate proofs using the local RISC Zero prover available to the validator.
Alternatively, proof generation can be delegated to an external service such as <a href="https://risczero.com/bonsai">Bonsai</a>,
or to the decentralized <a href="https://docs.beboundless.xyz/">Boundless proving network</a>.</p>
<div id="admonition-note-3" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-3-title">
<div class="admonition-title">
<div id="admonition-note-3-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-note-3"></a>
</div>
<div>
<p>All data required to generate the proof can be publicly derived from the public chain data available for your rollup,
making this process safe to delegate.</p>
</div>
</div>
<h3 id="bonsai"><a class="header" href="#bonsai">Bonsai</a></h3>
<p>Enabling proving using <a href="https://risczero.com/bonsai">Bonsai</a> requires you to set the following two environment variables before running the validator:</p>
<ul>
<li><code>BONSAI_API_KEY</code>: Your Bonsai API key.</li>
<li><code>BONSAI_API_URL</code>: Your Bonsai API url.</li>
</ul>
<div id="admonition-success-2" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-2-title">
<div class="admonition-title">
<div id="admonition-success-2-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-success-2"></a>
</div>
<div>
<p>Running <code>kailua-cli validate</code> with these two environment variables should now delegate all validator proving to <a href="https://risczero.com/bonsai">Bonsai</a>!</p>
</div>
</div>
<h3 id="boundless"><a class="header" href="#boundless">Boundless</a></h3>
<p>When delegating generation of Kailua Fault proofs to the decentralized <a href="https://docs.beboundless.xyz/">Boundless proving network</a>,
for every fault proof, a proof request is submitted to the network, where it goes through the standard
<a href="https://docs.beboundless.xyz/provers/proof-lifecycle">proof life-cycle</a> on boundless, before being published by
your validator to settle a dispute.</p>
<p>This functionality requires some additional parameters when starting the validator.
These parameters can be passed in as CLI arguments or set as environment variables</p>
<h4 id="proof-requests"><a class="header" href="#proof-requests">Proof Requests</a></h4>
<p>The following first set of parameters determine where/how requests are made:</p>
<ul>
<li><code>boundless-rpc-url</code>: The rpc endpoint of the L1 chain where the Boundless network is deployed.</li>
<li><code>boundless-wallet-key</code>: The wallet private key to use to send proof request transactions.</li>
<li><code>boundless-offchain</code>: (Optional) Flag instructing whether to submit proofs off-chain.</li>
<li><code>boundless-order-stream-url</code>: (Optional) The URL to use for off-chain order submission.</li>
<li><code>boundless-set-verifier-address</code>: The address of the RISC Zero verifier supporting aggregated proofs for order validation.</li>
<li><code>boundless-market-address</code>: The address of the Boundless market contract.</li>
<li><code>boundless-lookback</code>: (Defaults to <code>5</code>) The number of previous proof requests to inspect for duplicates before making a new proof request.</li>
<li><code>boundless-order-min-price-eth</code>: (Defaults to <code>0.0001</code>) Starting price per megacycle of proving orders.</li>
<li><code>boundless-order-max-price-eth</code>: (Defaults to <code>0.0002</code>) Maximum price per megacycle of proving orders.</li>
<li><code>boundless-order-ramp-up-period</code>: (Defaults to <code>60</code>) Time in seconds before order pricing increases.</li>
<li><code>boundless-order-lock-timeout-factor</code>: (Defaults to <code>3</code>) Multiplier for order fulfillment timeout after locking.</li>
<li><code>boundless-order-timeout-factor</code>: (Defaults to <code>10</code>) Multiplier for order expiry timeout after creation.</li>
<li><code>boundless-order-check-interval</code>: (Defaults to <code>12</code>) Time in seconds between attempts to check order status.</li>
</ul>
<div id="admonition-note-4" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-4-title">
<div class="admonition-title">
<div id="admonition-note-4-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-note-4"></a>
</div>
<div>
<p>Order timeouts are set by default to the number of megacycles in a proof request.
The multipliers allow you to scale these timeouts according to your expected proving speeds.
The default scale values give a 1 MHz prover 3x the amount of time it needs to fulfill a request once it's locked, and
10x its expected proving time as overall timeout.</p>
</div>
</div>
<h4 id="storage-provider"><a class="header" href="#storage-provider">Storage Provider</a></h4>
<p>The below second set of parameters determine where the proven executable and its input are stored:</p>
<ul>
<li><code>storage-provider</code>: One of <code>s3</code>, <code>pinata</code>, or <code>file</code>.</li>
<li><code>s3-access-key</code>: The <code>s3</code> access key.</li>
<li><code>s3-secret-key</code>: The <code>s3</code> secret key.</li>
<li><code>s3-bucket</code>: The <code>s3</code> bucket.</li>
<li><code>s3-url</code>: The <code>s3</code> url.</li>
<li><code>aws-region</code>: The <code>s3</code> region.</li>
<li><code>pinata-jwt</code>: The private <code>pinata</code> jwt.</li>
<li><code>pinata-api-url</code>: The <code>pinata</code> api URL.</li>
<li><code>ipfs-gateway-url</code>: The <code>pinata</code> gateway URL.</li>
<li><code>file-path</code>: The file storage provider path.</li>
</ul>
<div id="admonition-success-3" class="admonition admonish-success" role="note" aria-labelledby="admonition-success-3-title">
<div class="admonition-title">
<div id="admonition-success-3-title">
<p>Success</p>
</div>
<a class="admonition-anchor-link" href="validator.html#admonition-success-3"></a>
</div>
<div>
<p>Running <code>kailua-cli validate</code> with the above extra arguments should now delegate all validator proving to the <a href="https://docs.beboundless.xyz/">Boundless proving network</a>!</p>
</div>
</div>
<h2 id="advanced-settings"><a class="header" href="#advanced-settings">Advanced Settings</a></h2>
<p>Fault/Validity proof generation can be fine-tuned via the two following environment variables:</p>
<ul>
<li><code>NUM_CONCURRENT_PROVERS</code>: (default 1) The maximum number of prover instances to run concurrently in the validator.</li>
<li><code>NUM_CONCURRENT_PREFLIGHTS</code>: (default 4) Sets the number of concurrent data preflights per proving task.</li>
<li><code>NUM_CONCURRENT_PROOFS</code>: (default 1) Sets the number of concurrent proofs to seek per prover instance.</li>
<li><code>SEGMENT_LIMIT</code>: The <a href="https://docs.rs/risc0-zkvm/1.2.3/risc0_zkvm/struct.ExecutorEnvBuilder.html#method.segment_limit_po2">segment size limit</a> used for local proving (Default 21).</li>
<li><code>MAX_WITNESS_SIZE</code>: The maximum input size per single proof (Default 2.5GB).</li>
</ul>
<p>When manually computing individual proofs, the following parameters (or equiv. env. vars) take effect:</p>
<ul>
<li><code>SKIP_DERIVATION_PROOF</code>: Skips provably deriving L2 transactions using L1 data.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
